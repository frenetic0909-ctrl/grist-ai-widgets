<!DOCTYPE html>
<html>
<head>
  <title>Grist IA Bridge - Mapeo Estable</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body { font-family: sans-serif; margin: 15px; background-color: #1e1e1e; color: #e0e0e0; }
    h3 { color: #f5a623; display: flex; justify-content: space-between; align-items: center; }
    .card { background: #2b2b2b; padding: 15px; border-radius: 8px; border: 1px solid #444; margin-bottom: 15px; }
    textarea { 
      width: 95%; 
      padding: 10px; 
      background: #333; 
      color: white; 
      border: 1px solid #555; 
      border-radius: 4px; 
      resize: vertical;
    }
    button { 
      background: #f5a623; 
      color: black; 
      border: none; 
      padding: 12px 20px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-weight: bold; 
    }
    button:disabled { background: #666; cursor: not-allowed; }
    button.secondary { background: #444; color: white; font-size: 10px; padding: 5px; margin-left: 10px; }
    #result { 
      margin-top: 15px; 
      padding: 15px; 
      border-radius: 5px; 
      background: #121212; 
      border: 1px solid #f5a623; 
      white-space: pre-wrap; 
      min-height: 50px; 
      font-size: 14px;
      line-height: 1.5;
    }
    .status { color: #888; font-size: 12px; margin-top: 5px; }
  </style>
</head>

<body>
  <h3>
    Grist IA Bridge (Groq)
    <button class="secondary" onclick="resetKey()">Borrar API Key</button>
  </h3>
  
  <div class="card">
    <label>Instrucci√≥n para la IA:</label><br><br>
    <textarea id="prompt" rows="3">
Analiza esta fila y haz un resumen ejecutivo de los datos encontrados.
    </textarea>
  </div>

  <button id="btn">Enviar a Groq IA</button>
  <div class="status" id="status-text">Listo para procesar.</div>

  <div id="result">El resultado aparecer√° aqu√≠...</div>

  <script>
    // üîπ Configuraci√≥n inicial del widget
    grist.ready({
      requiredAccess: 'full',
      columns: [
        { name: "Analizar", optional: true, allowMultiple: true }
      ]
    });

    function resetKey() {
      localStorage.removeItem('groq_api_key');
      alert("API Key borrada.");
      location.reload();
    }

    document.getElementById('btn').onclick = async () => {
      const btn = document.getElementById('btn');
      const res = document.getElementById('result');
      const status = document.getElementById('status-text');
      
      let key = localStorage.getItem('groq_api_key');
      if (!key) {
        key = prompt("Introduce tu API Key de Groq (gsk_...):");
        if (key) localStorage.setItem('groq_api_key', key);
        else return;
      }

      btn.disabled = true;
      status.innerText = "Leyendo datos desde Grist...";

      try {
        // üîπ Obtenemos la fila seleccionada
        const row = await grist.fetchSelectedRecord();

        if (!row || !row.Analizar || row.Analizar.length === 0) {
          throw new Error("Seleccion√° al menos una columna en la secci√≥n ANALIZAR.");
        }

        // üîπ Construimos el objeto real con datos
        const cleanData = {};
        for (const col of row.Analizar) {
          cleanData[col] = row[col];
        }

        if (Object.keys(cleanData).length === 0) {
          throw new Error("Las columnas seleccionadas no contienen datos.");
        }

        console.log("Datos enviados a IA:", cleanData);

        status.innerText = "Procesando con Groq IA...";

        // üîπ Llamada a Groq
        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${key}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "llama-3.3-70b-versatile",
            messages: [
              { role: "system", content: "Eres un analista experto en datos." },
              { 
                role: "user", 
                content: `Datos:\n${JSON.stringify(cleanData, null, 2)}\n\nInstrucci√≥n:\n${document.getElementById('prompt').value}` 
              }
            ],
            temperature: 0.5
          })
        });

        const json = await response.json();
        if (json.error) throw new Error(json.error.message);

        res.innerText = json.choices[0].message.content;
        status.innerText = "An√°lisis completado.";

      } catch (e) {
        res.innerText = "‚ùå Error: " + e.message;
        status.innerText = "Error detectado.";
      } finally {
        btn.disabled = false;
      }
    };
  </script>
</body>
</html>
