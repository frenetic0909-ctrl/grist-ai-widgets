<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Analizador de filas Grist</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 12px;
    }
    button {
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    pre {
      background: #111;
      color: #0f0;
      padding: 10px;
      max-height: 300px;
      overflow: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>

<h3>Analizar filas seleccionadas</h3>
<button id="analyzeBtn">Analizar</button>

<pre id="debug"></pre>

<script>
const debug = (msg, data) => {
  const el = document.getElementById("debug");
  el.textContent += `\n${msg}`;
  if (data) {
    el.textContent += "\n" + JSON.stringify(data, null, 2);
  }
};

document.getElementById("analyzeBtn").onclick = async () => {
  try {
    debug("â–¶ Iniciando anÃ¡lisis...");

    // 1ï¸âƒ£ fila actual (cursor)
    const selected = await grist.fetchSelectedRecord();
    debug("Fila seleccionada:", selected);

    if (!selected || !selected.id) {
      debug("âŒ No hay fila seleccionada");
      return;
    }

    // 2ï¸âƒ£ tabla completa
    const table = await grist.fetchTable();
    debug("Tabla completa cargada. Filas:", table.length);

    // 3ï¸âƒ£ usar rowId para filtrar
    const rowsToAnalyze = table.filter(r => r.id === selected.id);

    if (!rowsToAnalyze.length) {
      debug("âŒ No se encontrÃ³ la fila en la tabla");
      return;
    }

    // 4ï¸âƒ£ limpiar datos
    const cleaned = rowsToAnalyze.map(row => {
      const obj = {};
      for (const [k, v] of Object.entries(row)) {
        if (k !== "id" && v !== null && v !== "") {
          obj[k] = v;
        }
      }
      return obj;
    });

    debug("Datos finales para IA:", cleaned);

    // ðŸ‘‰ acÃ¡ mandarÃ­as `cleaned` a tu IA
    debug("âœ… Listo para generar informe");

  } catch (err) {
    console.error(err);
    debug("ðŸ”¥ ERROR:", err.message);
  }
};
</script>

</body>
</html>
