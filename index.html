<script>
// ID técnico real detectado en tu vista de código
const tableId = "Base_unica"; 

grist.ready({ requiredAccess: 'full' });

document.getElementById("analyzeBtn").onclick = async function() {
  const btn = this;
  const out = document.getElementById("output");
  const promptText = document.getElementById("promptInput").innerText.trim();

  let apiKey = localStorage.getItem('groq_api_key');
  if (!apiKey) {
    apiKey = prompt("Introduce tu API Key de Groq (gsk_...):");
    if (apiKey) localStorage.setItem('groq_api_key', apiKey);
    else return;
  }

  btn.disabled = true;
  out.textContent = "⏳ Accediendo a la tabla '" + tableId + "'...";

  try {
    // Ahora Grist encontrará la tabla correctamente al usar el nombre exacto de la clase
    const tableData = await grist.docApi.fetchTable(tableId);
    const rowCount = tableData.id ? tableData.id.length : 0;
    
    out.textContent = `✅ ¡Tabla encontrada!\nRegistros: ${rowCount}\nEnviando a Groq para análisis...`;

    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "llama-3.3-70b-versatile",
        messages: [
          { role: "system", content: "Eres un analista de datos experto." },
          { role: "user", content: `Instrucción: ${promptText}\n\nDatos:\n${JSON.stringify(tableData)}` }
        ]
      })
    });

    const json = await response.json();
    if (json.error) throw new Error(json.error.message);
    out.textContent = json.choices[0].message.content;

  } catch (e) {
    out.innerHTML = `<span style="color: #f87171">❌ Error: ${e.message}</span><br><small>Verificá que el widget tenga "Acceso completo" en el panel derecho.</small>`;
  } finally {
    btn.disabled = false;
  }
};
</script>
