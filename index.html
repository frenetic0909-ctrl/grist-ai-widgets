<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Grist IA Auditor Final</title>
<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

<style>
  body { font-family: system-ui, sans-serif; background: #0f172a; color: #e5e7eb; padding: 12px; }
  .prompt-container {
    background: #020617; border: 1px solid #334155; border-radius: 6px;
    padding: 8px; min-height: 60px; outline: none; margin-bottom: 10px;
  }
  button {
    padding: 12px; border: none; border-radius: 6px; cursor: pointer;
    font-weight: bold; width: 100%; background: #f59e0b; color: #020617;
  }
  button:disabled { background: #475569; cursor: not-allowed; }
  pre {
    background: #1e293b; border: 1px solid #334155; border-radius: 6px;
    padding: 12px; margin-top: 15px; font-size: 13px; white-space: pre-wrap; color: #38bdf8;
  }
  .status { font-size: 11px; color: #94a3b8; margin-top: 5px; text-align: center; }
  .error { color: #f87171; font-weight: bold; border: 1px solid #f87171; padding: 10px; border-radius: 4px; }
</style>
</head>

<body>

<h3>üìä Auditor de Plantilla: Base_unica</h3>

<div id="promptInput" class="prompt-container" contenteditable="true">Analiza si hay errores o datos inconsistentes en esta tabla.</div>

<button id="analyzeBtn">Analizar Tabla Completa</button>
<div id="status" class="status">Cargando conexi√≥n con Grist...</div>

<pre id="output">Los resultados aparecer√°n aqu√≠...</pre>

<script>
// ID t√©cnico exacto basado en tu captura de la vista de c√≥digo
const tableId = "Base_unica"; 

// Funci√≥n de inicializaci√≥n segura
async function startWidget() {
  const status = document.getElementById("status");
  
  try {
    // Verificamos si la librer√≠a grist est√° cargada
    if (typeof grist === 'undefined') {
      throw new Error("La librer√≠a de Grist no carg√≥ correctamente. Refresca la p√°gina.");
    }

    // Inicializamos Grist con acceso total
    grist.ready({ requiredAccess: 'full' });
    status.innerText = "‚úÖ Conectado a Grist. Listo para procesar.";

  } catch (err) {
    document.getElementById("output").innerHTML = `<div class="error">‚ùå ${err.message}</div>`;
    status.innerText = "Error de conexi√≥n.";
  }
}

document.getElementById("analyzeBtn").onclick = async function() {
  const btn = this;
  const out = document.getElementById("output");
  const status = document.getElementById("status");
  const promptText = document.getElementById("promptInput").innerText.trim();

  let apiKey = localStorage.getItem('groq_api_key');
  if (!apiKey) {
    apiKey = prompt("Introduce tu API Key de Groq (gsk_...):");
    if (apiKey) localStorage.setItem('groq_api_key', apiKey);
    else return;
  }

  btn.disabled = true;
  out.textContent = "‚è≥ Leyendo tabla t√©cnica '" + tableId + "'...";

  try {
    // Descargamos los datos de la tabla Base_unica
    const tableData = await grist.docApi.fetchTable(tableId);
    const rowCount = tableData.id ? tableData.id.length : 0;
    
    status.innerText = `üì¶ Registros le√≠dos: ${rowCount}. Enviando a Groq...`;

    // Llamada a Groq
    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "llama-3.3-70b-versatile",
        messages: [
          { role: "system", content: "Eres un analista experto. Identifica inconsistencias en los datos proporcionados." },
          { role: "user", content: `Instrucci√≥n: ${promptText}\n\nDatos de la tabla:\n${JSON.stringify(tableData)}` }
        ]
      })
    });

    const json = await response.json();
    if (json.error) throw new Error(json.error.message);

    out.textContent = json.choices[0].message.content;
    status.innerText = "‚úÖ An√°lisis finalizado.";

  } catch (e) {
    out.innerHTML = `<div class="error">‚ùå Error: ${e.message}<br><br><small>Aseg√∫rate de tener "Acceso completo" habilitado en el panel de la derecha.</small></div>`;
    status.innerText = "Fallo en la lectura.";
  } finally {
    btn.disabled = false;
  }
};

// Arrancamos el widget
startWidget();
</script>

</body>
</html>
