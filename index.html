<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Grist IA Auditor</title>
<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

<style>
  body {
    font-family: system-ui, sans-serif;
    background: #0f172a;
    color: #e5e7eb;
    padding: 12px;
  }
  .prompt {
    background: #020617;
    border: 1px solid #334155;
    border-radius: 6px;
    padding: 8px;
    min-height: 100px;
    outline: none;
  }
  button {
    margin-top: 8px;
    padding: 8px 14px;
    background: #f59e0b;
    color: #020617;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
  button:hover { background: #d97706; }
  pre {
    background: #020617;
    border: 1px solid #334155;
    border-radius: 6px;
    padding: 10px;
    margin-top: 10px;
    font-size: 12px;
    white-space: pre-wrap;
  }
  .error { color: #f87171; }
</style>
</head>

<body>

<h3>ü§ñ Auditor IA</h3>

<div id="prompt" class="prompt" contenteditable="true">Analiza si hay errores en esta tabla...</div>

<button id="analyze">Analizar tabla</button>

<pre id="output">Esperando an√°lisis‚Ä¶</pre>

<script>
let tableId = null;

// Solicitamos acceso completo para poder leer la tabla correctamente
grist.ready({ requiredAccess: 'full' });

grist.on('configure', () => {
  grist.customSectionAPI.configure({
    settings: [{
      name: "tableId",
      label: "ID de la tabla a analizar (Ej: BASE_UNICA)",
      type: "text"
    }]
  });
});

grist.on('settings', (settings) => {
  tableId = settings?.tableId?.trim() || null;
});

document.getElementById("analyze").onclick = async function() {
  const out = document.getElementById("output");
  const promptText = document.getElementById("prompt").innerText.trim();

  // Validaciones con l√≥gica de salida limpia
  if (!tableId) {
    out.innerHTML = "<span class='error'>‚ùå Configur√° el ID de la tabla en el panel de Ajustes.</span>";
    return; 
  }

  if (!promptText) {
    out.innerHTML = "<span class='error'>‚ùå Escrib√≠ un prompt.</span>";
    return;
  }

  try {
    out.textContent = "‚è≥ Leyendo tabla...";

    // Obtenemos los datos. Grist devuelve un objeto con columnas
    const tableData = await grist.docApi.fetchTable(tableId);
    
    // En Grist, el n√∫mero de filas se sabe por el largo de cualquier columna (ej: 'id')
    const numFilas = tableData.id ? tableData.id.length : 0;

    out.textContent = `‚úÖ Conexi√≥n Exitosa
Tabla detectada: ${tableId}
Total de filas: ${numFilas}

üß† Tu instrucci√≥n:
"${promptText}"

üëâ Los datos est√°n cargados en memoria. 
(Siguiente paso: Conectar con Groq/Gemini usando estos datos).`;

    console.log("Datos de la tabla cargados:", tableData);

  } catch (e) {
    out.innerHTML = "<span class='error'>‚ùå Error: " + e.message + "</span>";
    console.error("Fallo al leer tabla:", e);
  }
};
</script>

</body>
</html>
