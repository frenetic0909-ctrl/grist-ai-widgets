<!DOCTYPE html>
<html>
<head>
  <title>Grist AI Bridge - Gemini Fix</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body { font-family: sans-serif; margin: 15px; background-color: #2e2e2e; color: #f0f0f0; }
    h3 { color: #58b668; display: flex; justify-content: space-between; align-items: center; }
    .section { margin-bottom: 20px; padding: 15px; border: 1px solid #444; border-radius: 5px; background-color: #3a3a3a; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    select, textarea { width: calc(100% - 10px); padding: 8px; margin-bottom: 10px; border: 1px solid #555; border-radius: 4px; background-color: #4a4a4a; color: #f0f0f0; }
    button { background-color: #58b668; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px; }
    button:hover { background-color: #4aa05d; }
    button.secondary { background-color: #666; }
    #result-area { margin-top: 20px; padding: 15px; border: 1px solid #58b668; border-radius: 5px; background-color: #2e2e2e; white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto; }
    .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #58b668; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; vertical-align: middle; margin-left: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h3>Grist AI Bridge <button class="secondary" onclick="resetApiKey()" style="font-size: 10px;">Configurar API Key</button></h3>

  <div class="section">
    <label for="analysis-scope">Alcance:</label>
    <select id="analysis-scope">
      <option value="selectedRow">Fila seleccionada</option>
      <option value="specificColumn">Columna específica</option>
      <option value="entireTable">Toda la tabla</option>
    </select>
    <div id="column-selector" style="display: none; margin-top: 10px;">
      <label>Columna:</label>
      <select id="target-column"></select>
    </div>
  </div>

  <div class="section">
    <label>Instrucción:</label>
    <textarea id="user-prompt" rows="3" placeholder="Ej: Resume estos datos..."></textarea>
  </div>

  <div class="section">
    <button id="send-to-ia">Enviar a IA</button>
    <div class="loading-spinner" id="spinner"></div>
    <button id="clear-result" class="secondary">Limpiar</button>
  </div>

  <div class="section">
    <div id="result-area">Esperando instrucciones...</div>
  </div>

  <script>
    let currentTableId = null;
    let columnNames = [];

    function getApiKey() {
      let key = localStorage.getItem('gemini_api_key');
      if (!key) {
        key = prompt("Introduce tu API Key de Gemini (Google AI Studio):");
        if (key) localStorage.setItem('gemini_api_key', key);
      }
      return key;
    }

    function resetApiKey() { localStorage.removeItem('gemini_api_key'); alert("Key borrada."); }

    grist.ready({
      requiredAccess: 'full',
      onNewData: (data) => {
        if (data && data.tableId) currentTableId = data.tableId;
        if (data && data.colIds) {
          columnNames = data.colIds;
          const select = document.getElementById('target-column');
          select.innerHTML = '';
          columnNames.forEach(id => {
            const opt = document.createElement('option');
            opt.value = id; opt.textContent = id;
            select.appendChild(opt);
          });
        }
      }
    });

    document.getElementById('analysis-scope').onchange = (e) => {
      document.getElementById('column-selector').style.display = e.target.value === 'specificColumn' ? 'block' : 'none';
    };

    async function collectData() {
      const scope = document.getElementById('analysis-scope').value;
      if (!currentTableId) currentTableId = await grist.selectedTable.getTableId();
      if (scope === 'selectedRow') return await grist.fetchSelectedRecord();
      const tableData = await grist.docApi.fetchTable(currentTableId);
      if (scope === 'specificColumn') return { [document.getElementById('target-column').value]: tableData[document.getElementById('target-column').value] };
      return tableData;
    }

    async function sendToIA(data, promptText) {
      const key = getApiKey();
      if (!key) return;
      document.getElementById('spinner').style.display = 'inline-block';
      
      // CAMBIO CLAVE: Usamos v1 y gemini-pro que es la ruta más estable
      const url = `https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=${key}`;

      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: `Datos: ${JSON.stringify(data)}\n\nInstrucción: ${promptText}` }] }]
          })
        });
        const json = await resp.json();
        if (json.error) throw new Error(json.error.message);
        return json.candidates[0].content.parts[0].text;
      } catch (e) { return "Error: " + e.message; }
      finally { document.getElementById('spinner').style.display = 'none'; }
    }

    document.getElementById('send-to-ia').onclick = async () => {
      const result = await sendToIA(await collectData(), document.getElementById('user-prompt').value);
      document.getElementById('result-area').textContent = result;
    };

    document.getElementById('clear-result').onclick = () => { document.getElementById('result-area').textContent = 'Esperando...'; };
  </script>
</body>
</html>
