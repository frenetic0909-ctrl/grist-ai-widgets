<!DOCTYPE html>
<html>
<head>
  <title>Grist AI Bridge - Stable</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body { font-family: sans-serif; margin: 10px; background-color: #2e2e2e; color: #f0f0f0; }
    .card { background: #3a3a3a; padding: 10px; border-radius: 5px; border: 1px solid #444; margin-bottom: 10px; }
    textarea { width: 95%; padding: 8px; background: #4a4a4a; color: white; border: 1px solid #555; }
    button { background: #58b668; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; }
    #result { margin-top: 10px; padding: 10px; border: 1px solid #58b668; background: #1e1e1e; white-space: pre-wrap; font-size: 13px; }
  </style>
</head>
<body>
  <div class="card">
    <strong>Grist AI Bridge</strong> 
    <button onclick="localStorage.removeItem('g_key'); alert('Key borrada')">Limpiar Key</button>
  </div>

  <div class="card">
    <label>Instrucción:</label><br>
    <textarea id="prompt" rows="2">Resume esta fila</textarea>
  </div>

  <button id="run">Enviar a Gemini Pro</button>

  <div id="result">Esperando...</div>

  <script>
    let tableId = "";
    
    // 1. Conexión con Grist
    grist.ready({
      requiredAccess: 'full',
      onNewData: (data) => { if(data.tableId) tableId = data.tableId; }
    });

    // 2. Función de envío
    document.getElementById('run').onclick = async () => {
      let key = localStorage.getItem('g_key');
      if(!key) {
        key = prompt("Pega tu API Key de Google AI Studio:");
        if(key) localStorage.setItem('g_key', key);
      }

      document.getElementById('result').innerText = "Procesando...";
      
      try {
        const row = await grist.fetchSelectedRecord();
        // USAMOS EL MODELO MÁS ESTABLE: gemini-1.5-pro
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${key}`;
        
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: `Datos: ${JSON.stringify(row)}\n\nInstrucción: ${document.getElementById('prompt').value}` }] }]
          })
        });

        const json = await resp.json();
        if(json.error) throw new Error(json.error.message);
        document.getElementById('result').innerText = json.candidates[0].content.parts[0].text;
      } catch (e) {
        document.getElementById('result').innerText = "Error: " + e.message;
      }
    };
  </script>
</body>
</html>
