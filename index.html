<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Grist IA Auditor</title>
<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

<style>
  body {
    font-family: system-ui, sans-serif;
    background: #0f172a;
    color: #e5e7eb;
    padding: 12px;
  }

  .prompt {
    background: #020617;
    border: 1px solid #334155;
    border-radius: 6px;
    padding: 8px;
    min-height: 100px;
    outline: none;
    white-space: pre-wrap;
  }

  .prompt:empty::before {
    content: "Escrib√≠ ac√° qu√© quer√©s analizar (duplicados, errores, inconsistencias...)";
    color: #64748b;
  }

  button {
    margin-top: 8px;
    padding: 8px 14px;
    background: #f59e0b;
    color: #020617;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }

  pre {
    background: #020617;
    border: 1px solid #334155;
    border-radius: 6px;
    padding: 10px;
    margin-top: 10px;
    font-size: 12px;
    white-space: pre-wrap;
  }

  .error { color: #f87171; }
</style>
</head>

<body>

<h3>ü§ñ Auditor IA (modo conversacional)</h3>

<div id="prompt" class="prompt" contenteditable="true"></div>

<button id="analyze">Analizar tabla</button>

<pre id="output">Esperando an√°lisis‚Ä¶</pre>

<script>
let tableId = null;

grist.ready({ requiredAccess: 'readOnly' });

/* CONFIG PANEL DERECHO */
grist.on('configure', () => {
  grist.customSectionAPI.configure({
    settings: [{
      name: "tableId",
      label: "ID de la tabla a analizar",
      type: "text",
      placeholder: "ej: base_unica"
    }]
  });
});

grist.on('settings', (s) => {
  tableId = s?.tableId || null;
});

document.getElementById("analyze").onclick = async () => {
  const out = document.getElementById("output");
  const promptText = document.getElementById("prompt").innerText.trim();

  if (!promptText) {
    out.innerHTML = "<span class='error'>‚ùå Escrib√≠ un prompt primero.</span>";
    return;
  }

  if (!tableId) {
    out.innerHTML = "<span class='error'>‚ùå Configur√° el ID de la tabla.</span>";
    return;
  }

  try {
    out.textContent = "‚è≥ Leyendo tabla‚Ä¶";

    const table = await grist.docApi.fetchTable(tableId);

    if (!table?.records?.length) {
      throw new Error("La tabla est√° vac√≠a o no existe.");
    }

    out.textContent =
`‚úÖ Tabla: ${tableId}
Filas: ${table.records.length}
Columnas: ${Object.keys(table.records[0]).join(", ")}

üß† Prompt:
${promptText}

üëâ Lista para an√°lisis IA`;

    // üîú ac√° va Groq / OpenAI

  } catch (e) {
    out.innerHTML = `<span class="error">‚ùå ${e.message}</span>`;
    console.error(e);
  }
};
</script>

</body>
</html>

