<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Grist AI Auditor - Full Column Support</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background: #0f172a; color: #e5e7eb; padding: 12px; margin: 0; }
    .container { display: flex; flex-direction: column; height: 98vh; }
    .chat-box { flex-grow: 1; background: #020617; border: 1px solid #334155; border-radius: 8px; padding: 12px; overflow-y: auto; margin-bottom: 10px; }
    .input-area { background: #1e293b; padding: 15px; border-radius: 8px; border: 1px solid #334155; }
    textarea { 
      width: 100%; background: #0f172a; color: white; border: 1px solid #475569; 
      border-radius: 6px; padding: 10px; resize: none; margin-bottom: 10px; box-sizing: border-box;
    }
    button { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; background: #f59e0b; color: #020617; }
    button:disabled { background: #475569; cursor: not-allowed; }
    .status { font-size: 11px; color: #94a3b8; margin-top: 5px; text-align: center; }
    .msg { margin-bottom: 15px; line-height: 1.5; font-size: 14px; }
    .ai-msg { color: #38bdf8; white-space: pre-wrap; background: #0f172a; padding: 10px; border-radius: 4px; }
    .user-msg { color: #f59e0b; font-weight: bold; margin-bottom: 4px; display: block; }
  </style>
</head>
<body>

<div class="container">
  <div class="chat-box" id="chatOutput">
    <div class="msg ai-msg">ü§ñ <b>Auditor de Plantilla Completa</b>.
He cargado todas las columnas de <b>Base_unica</b>.
¬øQu√© an√°lisis profundo necesitas realizar sobre las 1611 filas?</div>
  </div>

  <div class="input-area">
    <textarea id="userInput" rows="3" placeholder="Ej: Revisa todas las columnas y dime qu√© filas tienen datos inconsistentes o duplicados..."></textarea>
    <button id="sendBtn">Enviar Orden de An√°lisis</button>
    <div class="status" id="status">Listo para procesar todas las columnas.</div>
  </div>
</div>

<script>
const TABLE_ID = "Base_unica";
grist.ready({ requiredAccess: 'full' });

// Funci√≥n para convertir objeto Grist a CSV compacto
function tableToCSV(data) {
  const columns = Object.keys(data).filter(k => k !== 'ManualSortPos');
  let csv = columns.join(",") + "\n";
  const numRows = data.id.length;
  
  for (let i = 0; i < numRows; i++) {
    const row = columns.map(col => {
      let val = data[col][i];
      if (val === null || val === undefined) return "";
      return typeof val === 'string' ? `"${val.replace(/"/g, '""')}"` : val;
    });
    csv += row.join(",") + "\n";
  }
  return csv;
}

document.getElementById("sendBtn").onclick = async () => {
  const input = document.getElementById("userInput");
  const chat = document.getElementById("chatOutput");
  const status = document.getElementById("status");
  const userText = input.value.trim();

  if (!userText) return;

  chat.innerHTML += `<div class="msg"><span class="user-msg">T√∫:</span> ${userText}</div>`;
  input.value = "";
  status.innerText = "‚è≥ Extrayendo y comprimiendo 1611 filas...";

  try {
    const data = await grist.docApi.fetchTable(TABLE_ID);
    const csvData = tableToCSV(data); // Compresi√≥n de datos
    
    status.innerText = "üß† Analizando todas las columnas con Groq...";

    const apiKey = localStorage.getItem('groq_key') || prompt("Introduce tu API Key de Groq:");
    if (apiKey) localStorage.setItem('groq_key', apiKey);

    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "llama-3.3-70b-versatile",
        messages: [
          { role: "system", content: "Eres un auditor de datos. Analizar√°s una tabla completa en formato CSV. Busca errores, duplicados y responde a las √≥rdenes del usuario con precisi√≥n t√©cnica." },
          { role: "user", content: `Datos CSV:\n${csvData}\n\nOrden: ${userText}` }
        ]
      })
    });

    const result = await response.json();
    if (result.choices) {
      chat.innerHTML += `<div class="msg"><span class="user-msg" style="color:#38bdf8">ü§ñ Auditor IA:</span><div class="ai-msg">${result.choices[0].message.content}</div></div>`;
      status.innerText = "‚úÖ An√°lisis total completado.";
    } else {
      throw new Error(result.error.message);
    }
  } catch (e) {
    chat.innerHTML += `<div class="msg" style="color:#f87171">‚ùå Error: ${e.message}</div>`;
    status.innerText = "Error en el proceso.";
  }
  chat.scrollTop = chat.scrollHeight;
};
</script>

</body>
</html>
