<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Grist IA ‚Äì Auditor de Datos</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  <style>
    body {
      font-family: sans-serif;
      background: #1e1e1e;
      color: #e0e0e0;
      margin: 15px;
    }
    h3 {
      color: #f5a623;
      margin-bottom: 10px;
    }
    textarea {
      width: 100%;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 6px;
      padding: 10px;
      resize: vertical;
    }
    button {
      margin-top: 10px;
      background: #f5a623;
      color: #000;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button:disabled {
      background: #777;
      cursor: not-allowed;
    }
    #status {
      margin-top: 8px;
      font-size: 12px;
      color: #aaa;
    }
    #result {
      margin-top: 15px;
      background: #121212;
      border: 1px solid #f5a623;
      border-radius: 6px;
      padding: 12px;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.5;
    }
    .debug {
      margin-top: 10px;
      font-size: 11px;
      color: #888;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <h3>üß† Auditor IA del Documento</h3>

  <label>¬øQu√© quer√©s analizar?</label>
  <textarea id="prompt" rows="3">
Detect√° inconsistencias, nombres duplicados y errores de escritura.
  </textarea>

  <button id="analyzeBtn">Analizar tabla completa</button>
  <div id="status">Listo.</div>

  <div id="result">El an√°lisis aparecer√° ac√°‚Ä¶</div>
  <div id="debug" class="debug"></div>

<script>
grist.ready({ requiredAccess: 'full' });

const btn = document.getElementById('analyzeBtn');
const status = document.getElementById('status');
const result = document.getElementById('result');
const debug = document.getElementById('debug');

btn.onclick = async () => {
  btn.disabled = true;
  status.textContent = "üìä Cargando tabla completa‚Ä¶";
  result.textContent = "";
  debug.textContent = "";

  try {
    // API Key
    let apiKey = localStorage.getItem("groq_api_key");
    if (!apiKey) {
      apiKey = prompt("Ingres√° tu API Key de Groq (gsk_...)");
      if (!apiKey) throw new Error("API Key no ingresada");
      localStorage.setItem("groq_api_key", apiKey);
    }

    // Obtener TODA la tabla actual
    const table = await grist.docApi.fetchTable(null);

    if (!table || !table.records || table.records.length === 0) {
      throw new Error("La tabla est√° vac√≠a o no se pudo leer.");
    }

    debug.textContent =
      "DEBUG:\n" +
      `Filas: ${table.records.length}\n` +
      `Columnas: ${Object.keys(table.records[0]).join(", ")}`;

    status.textContent = "ü§ñ Analizando con IA‚Ä¶";

    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "llama-3.3-70b-versatile",
        temperature: 0.3,
        messages: [
          {
            role: "system",
            content: `
Sos un auditor experto en calidad de datos.
Analiz√°s tablas completas.
NO modifiques datos.
Marc√° errores con ‚ö†Ô∏è.
Indic√° siempre FILA y COLUMNA.
Modo mixto: explicaci√≥n + lista completa de errores.
`
          },
          {
            role: "user",
            content: `
TABLA COMPLETA (JSON):
${JSON.stringify(table.records)}

CONSULTA DEL USUARIO:
${document.getElementById("prompt").value}
`
          }
        ]
      })
    });

    const json = await response.json();
    if (json.error) throw new Error(json.error.message);

    result.textContent = json.choices[0].message.content;
    status.textContent = "‚úÖ An√°lisis completo.";

  } catch (err) {
    result.textContent = "‚ùå Error: " + err.message;
    status.textContent = "Error.";
  } finally {
    btn.disabled = false;
  }
};
</script>
</body>
</html>
