<!DOCTYPE html>
<html>
<head>
  <title>Grist AI Bridge - Groq Speed</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body { font-family: sans-serif; margin: 15px; background-color: #1e1e1e; color: #e0e0e0; }
    .container { max-width: 100%; }
    h3 { color: #f5a623; display: flex; justify-content: space-between; }
    .card { background: #2b2b2b; padding: 15px; border-radius: 8px; border: 1px solid #444; margin-bottom: 15px; }
    textarea { width: 95%; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 4px; }
    button { background: #f5a623; color: black; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    button:disabled { background: #666; cursor: not-allowed; }
    #result { margin-top: 15px; padding: 15px; border-radius: 5px; background: #121212; border: 1px solid #f5a623; white-space: pre-wrap; min-height: 50px; }
  </style>
</head>
<body>
  <div class="container">
    <h3>Grist IA Bridge <button onclick="reset()" style="font-size:10px; background:#444; color:white;">Reset Key</button></h3>
    
    <div class="card">
      <label>Instrucciones para la IA:</label><br><br>
      <textarea id="prompt" rows="3">Analiza esta fila y dime si faltan datos importantes o hay errores.</textarea>
    </div>

    <button id="btn">Analizar Fila Seleccionada</button>

    <div id="result">El resultado aparecerá aquí...</div>
  </div>

  <script>
    function reset() { localStorage.removeItem('groq_key'); location.reload(); }

    grist.ready({ requiredAccess: 'full' });

    document.getElementById('btn').onclick = async () => {
      let key = localStorage.getItem('groq_key');
      if(!key) {
        key = prompt("Introduce tu API Key de Groq (consíguela gratis en console.groq.com):");
        if(key) localStorage.setItem('groq_key', key);
        else return;
      }

      const btn = document.getElementById('btn');
      const res = document.getElementById('result');
      
      btn.disabled = true;
      res.innerText = "Consultando a la IA...";

      try {
        const row = await grist.fetchSelectedRecord();
        if(!row || row.id === 0) throw new Error("Por favor, selecciona una fila en la tabla primero.");

        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${key}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "llama-3.3-70b-versatile",
            messages: [
              { role: "system", content: "Eres un analista de datos para un proyecto de digitalización de planos." },
              { role: "user", content: `Datos de la fila: ${JSON.stringify(row)}\n\nInstrucción: ${document.getElementById('prompt').value}` }
            ]
          })
        });

        const json = await response.json();
        if(json.error) throw new Error(json.error.message);
        res.innerText = json.choices[0].message.content;

      } catch (e) {
        res.innerText = "Error: " + e.message;
        if(e.message.includes("API key")) localStorage.removeItem('groq_key');
      } finally {
        btn.disabled = false;
      }
    };
  </script>
</body>
</html>
