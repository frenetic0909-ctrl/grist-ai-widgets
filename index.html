<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Grist IA ‚Äì Auditor Conversacional</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      padding: 12px;
    }
    h3 {
      margin-top: 0;
    }
    textarea {
      width: 100%;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #334155;
      border-radius: 6px;
      padding: 8px;
      resize: vertical;
    }
    button {
      margin-top: 8px;
      padding: 8px 14px;
      background: #f59e0b;
      color: #020617;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button:disabled {
      background: #64748b;
      cursor: not-allowed;
    }
    pre {
      background: #020617;
      padding: 10px;
      font-size: 12px;
      white-space: pre-wrap;
      border-radius: 6px;
      border: 1px solid #334155;
      margin-top: 10px;
    }
    .error {
      color: #f87171;
    }
    .debug {
      color: #94a3b8;
      font-size: 11px;
      margin-top: 8px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

<h3>üß† Auditor IA (modo chat)</h3>

<label>¬øQu√© quer√©s analizar?</label>
<textarea id="prompt" rows="4">
Detect√° inconsistencias, duplicados y errores de escritura.
Marc√° cada problema con ‚ö†Ô∏è indicando fila y columna.
</textarea>

<button id="analyzeBtn">Analizar tabla completa</button>

<pre id="result">Esperando consulta‚Ä¶</pre>
<div id="debug" class="debug"></div>

<script>
let tableId = null;

grist.ready({ requiredAccess: 'full' });

/* CONFIGURACI√ìN DEL WIDGET (panel derecho) */
grist.on('configure', () => {
  grist.customSectionAPI.configure({
    settings: [
      {
        name: "tableId",
        label: "ID de la tabla a analizar",
        type: "text",
        placeholder: "ej: base_unica"
      }
    ]
  });
});

/* LECTURA DE CONFIG GUARDADA */
grist.on('settings', (settings) => {
  tableId = settings?.tableId?.trim() || null;
});

const btn = document.getElementById("analyzeBtn");
const result = document.getElementById("result");
const debug = document.getElementById("debug");

btn.onclick = async () => {
  btn.disabled = true;
  result.textContent = "‚è≥ Leyendo tabla‚Ä¶";
  debug.textContent = "";

  try {
    if (!tableId) {
      throw new Error("Debes configurar el ID de la tabla en el panel derecho.");
    }

    /* API KEY */
    let apiKey = localStorage.getItem("groq_api_key");
    if (!apiKey) {
      apiKey = prompt("Ingres√° tu API Key de Groq (gsk_...)");
      if (!apiKey) throw new Error("API Key no ingresada.");
      localStorage.setItem("groq_api_key", apiKey);
    }

    /* LEER TABLA COMPLETA */
    const table = await grist.docApi.fetchTable(tableId);

    if (!table?.records?.length) {
      throw new Error("La tabla est√° vac√≠a o no existe.");
    }

    debug.textContent =
      `DEBUG\nTabla: ${tableId}\n` +
      `Filas: ${table.records.length}\n` +
      `Columnas: ${Object.keys(table.records[0]).join(", ")}`;

    result.textContent = "ü§ñ Analizando con IA‚Ä¶";

    /* IA */
    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "llama-3.3-70b-versatile",
        temperature: 0.3,
        messages: [
          {
            role: "system",
            content: `
Sos un auditor experto en calidad de datos.
Analiz√°s TODA la tabla.
NO modifiques datos.
Respond√© en modo mixto.
Marc√° errores con ‚ö†Ô∏è indicando FILA y COLUMNA exactas.
`
          },
          {
            role: "user",
            content: `
TABLA (JSON):
${JSON.stringify(table.records)}

CONSULTA:
${document.getElementById("prompt").value}
`
          }
        ]
      })
    });

    const json = await response.json();
    if (json.error) throw new Error(json.error.message);

    result.textContent = json.choices[0].message.content;

  } catch (err) {
    result.innerHTML = `<span class="error">‚ùå ${err.message}</span>`;
  } finally {
    btn.disabled = false;
  }
};
</script>

</body>
</html>
